<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nonna's Pizza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="CSS/Dashboard.css">  
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img class="img-fluid" src="Imagenes/nonnaLogo.png">
            </div>
            <h5 class="sidebar-text mb-0">Nonna's Pizza</h5>
            <small class="sidebar-text">Panel de gestión</small>
        </div>
        
        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="Dashboard.html">
                        <i class="bi bi-speedometer2"></i>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="PuntoVenta.html">
                        <i class="bi bi-cash-coin"></i>
                        <span class="sidebar-text">Punto de Venta</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Entregas.html">
                        <i class="bi bi-truck"></i>
                        <span class="sidebar-text">Entregas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Inventario.html">
                        <i class="bi bi-box-seam"></i>
                        <span class="sidebar-text">Catalogo</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Configuracion.html">
                        <i class="bi bi-gear"></i>
                        <span class="sidebar-text">Configuración</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><img class="img-fluid" src="Imagenes/Perfil2.jpg"></div>
                <div class="user-details sidebar-text">
                    <p class="user-name mb-0">Administrador</p>
                    <p class="user-role mb-0"><span class="status-badge"></span> Activo</p>
                </div>
            </div>
            
            <div class="sidebar-action">
                <i class="bi bi-bell"></i>
                <span class="sidebar-text">Notificaciones</span>
            </div>
            
            <div class="sidebar-action">
                <i class="bi bi-box-arrow-right"></i>
                <span class="sidebar-text">Cerrar Sesión</span>
            </div>
        </div>
    </div>
    
    <!-- Pagina Principal -->
    <div id="content">
        <!-- Sección Superior -->
        <nav class="top-navbar">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-6 d-flex align-items-center">
                        <button id="sidebarToggle" class="btn btn-sm btn-outline-secondary me-3">
                            <i class="bi bi-list"></i>
                        </button>
                        <nav aria-label="breadcrumb" class="flex-grow-1">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">Administrador</li>
                                <li class="breadcrumb-item active">Dashboard</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="date-display me-3" id="currentDate"></span>
                        <div class="notification-badge d-inline-block">
                            <i class="bi bi-bell fs-5 text-muted"></i>
                            <span class="badge bg-danger rounded-pill" id="notifCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Contenido de Dashboard -->
        <div class="page-content">
            <div class="container-fluid">
                <h2 class="mb-2 p-3">Dashboard Administrativo</h2>
                
                <!-- Sección Tarjetas de Métricas Principales -->
                <div class="row mb-5">
                    <div class="col-md-3 mb-4">
                        <div class="card dashboard-card bg-white">
                            <div class="card-title">
                                <span>Ventas Totales</span>
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <div class="card-value text-black" id="ventasTotales">S/ 0.00</div>
                            <div class="card-trend trend-positive">
                                <i class="bi bi-graph-up me-1"></i>
                                Total acumulado
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card dashboard-card bg-white">
                            <div class="card-title">
                                <span>Pedidos Totales</span>
                                <i class="bi bi-cart3"></i>
                            </div>
                            <div class="card-value" id="pedidosTotales">0</div>
                            <div class="card-trend trend-positive">
                                <i class="bi bi-receipt me-1"></i>
                                Compras registradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card dashboard-card bg-white">
                            <div class="card-title">
                                <span>Productos</span>
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="card-value" id="totalProductos">0</div>
                            <div class="card-trend trend-neutral">
                                <i class="bi bi-pizza me-1"></i>
                                En catálogo
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card dashboard-card bg-white">
                            <div class="card-title">
                                <span>Promociones Activas</span>
                                <i class="bi bi-percent"></i>
                            </div>
                            <div class="card-value" id="promoActivas">0</div>
                            <div class="card-trend trend-positive">
                                <i class="bi bi-tag me-1"></i>
                                Vigentes ahora
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Pedidos Recientes -->
                <div class="card mb-5">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <div>
                            <i class="bi bi-clock-history me-2"></i>
                            <span>Pedidos Recientes</span>
                        </div>
                        <a href="Entregas.html" class="btn btn-sm btn-outline-primary">Ver todos</a>
                    </div>
                    <div class="card-body" id="pedidosRecientes">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split fs-1"></i>
                            <p>Cargando pedidos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Resumen del Catálogo -->
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card metrica-card">
                            <div class="metrica-titulo">
                                <i class="bi bi-box"></i>
                                Productos en Catálogo
                            </div>
                            <div class="metrica-valor" id="metricaProductos">0</div>
                            <div class="barra-progreso">
                                <div class="barra-progreso-fill tiempo" style="width: 100%"></div>
                            </div>
                            <div class="metrica-meta">Pizzas disponibles</div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card metrica-card">
                            <div class="metrica-titulo">
                                <i class="bi bi-percent"></i>
                                Promociones
                            </div>
                            <div class="metrica-valor" id="metricaPromociones">0</div>
                            <div class="barra-progreso">
                                <div class="barra-progreso-fill satisfaccion" style="width: 80%"></div>
                            </div>
                            <div class="metrica-meta">Total registradas</div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card metrica-card">
                            <div class="metrica-titulo">
                                <i class="bi bi-plus-circle"></i>
                                Extras Disponibles
                            </div>
                            <div class="metrica-valor" id="metricaExtras">0</div>
                            <div class="barra-progreso">
                                <div class="barra-progreso-fill eficiencia" style="width: 60%"></div>
                            </div>
                            <div class="metrica-meta">Ingredientes adicionales</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="JS/main.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';

        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosDashboard();
        });

        async function cargarDatosDashboard() {
            try {
                // Cargar datos en paralelo
                const [productosRes, promocionesRes, extrasRes, comprasRes] = await Promise.all([
                    fetch(`${API_BASE}/productos`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/promociones`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/extras`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/compras/todas`).catch(() => ({ ok: false }))
                ]);

                // Procesar productos
                let productos = [];
                if (productosRes.ok) {
                    productos = await productosRes.json();
                    document.getElementById('totalProductos').textContent = productos.length;
                    document.getElementById('metricaProductos').textContent = productos.length;
                }

                // Procesar promociones
                let promociones = [];
                if (promocionesRes.ok) {
                    promociones = await promocionesRes.json();
                    document.getElementById('metricaPromociones').textContent = promociones.length;
                    
                    // Contar activas
                    const hoy = new Date();
                    const activas = promociones.filter(p => {
                        const inicio = new Date(p.fechaInicio);
                        const fin = new Date(p.fechaFin);
                        return hoy >= inicio && hoy <= fin;
                    });
                    document.getElementById('promoActivas').textContent = activas.length;
                }

                // Procesar extras
                if (extrasRes.ok) {
                    const extras = await extrasRes.json();
                    document.getElementById('metricaExtras').textContent = extras.length;
                }

                // Procesar compras
                let compras = [];
                if (comprasRes.ok) {
                    compras = await comprasRes.json();
                    document.getElementById('pedidosTotales').textContent = compras.length;
                    
                    // Calcular ventas totales
                    const totalVentas = compras.reduce((sum, c) => sum + parseFloat(c.precioTotal || 0), 0);
                    document.getElementById('ventasTotales').textContent = `S/ ${totalVentas.toFixed(2)}`;
                    
                    // Mostrar últimos 5 pedidos
                    renderizarPedidosRecientes(compras.slice(-5).reverse());
                }

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                document.getElementById('pedidosRecientes').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No se pudo conectar con el servidor. Verifica que el backend esté corriendo.
                    </div>
                `;
            }
        }

        function renderizarPedidosRecientes(compras) {
            const container = document.getElementById('pedidosRecientes');
            
            if (compras.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p>No hay pedidos registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = compras.map(compra => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <div class="pedido-numero">#${compra.idCompra}</div>
                        <div class="pedido-precio">S/ ${parseFloat(compra.precioTotal || 0).toFixed(2)}</div>
                    </div>
                    <div class="pedido-info">
                        <div class="pedido-tipo">${compra.tipoEnvio || 'N/A'}</div>
                        <span class="pedido-estado estado-listo">${compra.metodoPago || 'Completado'}</span>
                    </div>
                    <div class="pedido-tiempo tiempo-completado">${formatearFecha(compra.fechaCompra)}</div>
                </div>
            `).join('');
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const d = new Date(fecha);
            return d.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>